<!DOCTYPE html>
<html>
<head>
    <% include partials/head %>
    <style>
        .dflex{
            flex: 1;    
        }
    </style>
</head>
<body>
    <% include partials/nav %>
    <main> 
        <div id="app" class="container">
            <div class="row">
                <div class="col s12 m8">
                    <form @submit.prevent="getBars(city)">
                        <input type="text" name="cityname" placeholder="Enter City Name" v-model:value="city">
                        <button class="btn" type="submit">Enter</button>
                    </form>
                </div>
            </div>

            <!-- static data to prevent ejs from complaining -->
            <% let bar = "" %>
            <div class="row" >
                <div v-for="(bar, index) in bars">
                    <div class="col s12 m6 l4 dflex">
                            <div class="card blue-grey darken-1">
                                    <div class="card-content white-text">
                                        <span class="h3 card-title"> {{ bar.name}} </span>
                                        <a @click="checkAttend(bars[index]._id,index)"><span>Going: {{ bar["usersAttending"].length}}</span></a>
                                        <p>{{ bar["formatted_address"] }}</p>
                                        <i  v-for="glass in Math.floor(bar.rating)" class="material-icons amber-text">local_bar</i>                             
                                    </div>
                                </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
    
    <% include partials/foot-css %>
    <% include partials/foot %> 
    <script>
        let app = new Vue({
            el:"#app",
            data:{
                city:"",
                bars:[]
            },
            methods:{
                getBars:function(cityname){
                   let vm = this;
                   console.log("fired")
                    axios.get("http://localhost:3000/search/"+cityname.trim())
                    .then((res) => {
                        vm.bars = res.data
                    })
                    .catch((err) => {
                        console.log("an error occurred")
                    })
                },
                checkAttend: function(barId,index){
                    console.log("check attending");
                    let vm = this;
                    axios.get("http://localhost:3000/search/going/"+barId.trim())
                    .then((res) => {
                        if(res.data == "add"){
                            vm.bars[index].usersAttending.push({name:"new user"});
                        }
                        else{
                            vm.bars[index].usersAttending.pop();
                        }
                    })
                    .catch((err) => {
                        console.log("oops error occurred");
                    })
                }
            }
        })
    </script>
</body>
</html>